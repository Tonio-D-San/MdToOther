@startuml
title Counterpart API - Routes & Service Flows

left to right direction

skinparam rectangle {
  BackgroundColor #E8F8F5
  BorderColor #1ABC9C
  Shadowing false
}

' ==== API Layer ====
rectangle "Counterpart API (/v1/counterparts)" as CounterpartAPI {
  [GET /{id}] --> [CounterpartService.SEARCH_BY_ID] : Request
  [PATCH /{id}] --> [CounterpartService.UPDATE_BY_ID] : Request
  [POST] --> [CounterpartService.CREATE] : Request
  [DELETE /{id}] --> [CounterpartService.DELETE_BY_ID] : Request
  [POST /search] --> [CounterpartService.SEARCH] : Request
  [POST /import] --> [CounterpartService.CREATE_FROM_EXCEL] : Request
}

' ==== Service Layer ====
rectangle "CounterpartService" as Service {
  [SEARCH]
  [SEARCH_BY_ID]
  [UPDATE_BY_ID]
  [UPDATE_MULTI]
  [CREATE]
  [CREATE_MULTI]
  [CREATE_FROM_EXCEL]
  [CREATE_NODE_FOR_LIST]
  [SEARCH_FOR_CREATE_NODE]
  [DELETE_BY_ID]
}

CounterpartAPI --> Service

' ==== External Services ====
rectangle "External MS (meRepurposingReg)" as External {
  [POST /v1/counterparts/search]
  [GET /v1/counterparts/{id}]
  [PATCH /v1/counterparts/multi]
  [POST /v1/counterparts/multi]
  [DELETE /v1/counterparts/{id}]
}

rectangle "Document Node MS (meEcDocument)" as NodeService {
  [POST /v1/documents/nodes]
  [PUT /v1/documents/nodes/{nodeId}]
}

' ==== Internal Flows ====
[CREATE] --> [CREATE_MULTI]
[CREATE_MULTI] --> External : POST /v1/counterparts/multi
[CREATE] --> [CREATE_NODE_FOR_LIST] : async wireTap
[CREATE_FROM_EXCEL] --> [CREATE_MULTI]
[CREATE_FROM_EXCEL] --> [CREATE_NODE_FOR_LIST] : async wireTap
[CREATE_NODE_FOR_LIST] --> [SEARCH_FOR_CREATE_NODE]
[SEARCH_FOR_CREATE_NODE] --> [SEARCH]
[SEARCH] --> External : POST /v1/counterparts/search
[UPDATE_BY_ID] --> [UPDATE_MULTI]
[UPDATE_MULTI] --> External : PATCH /v1/counterparts/multi
[DELETE_BY_ID] --> External : DELETE /v1/counterparts/{id}
[SEARCH_BY_ID] --> External : GET /v1/counterparts/{id}
[CREATE_NODE_FOR_LIST] --> NodeService : create node per Counterpart

note bottom of CounterpartAPI
Ogni endpoint REST invoca una route interna di servizio.
Le operazioni CREATE e IMPORT avviano un flusso asincrono
per la creazione dei nodi documentali.
end note

@enduml
