@startuml
title Flusso Counterpart API - POST /v1/counterparts

actor Client as C
participant "Counterpart BS (borepurposingmgmt)" as BS
participant "Counterpart MS (meRepurposingReg)" as MS
participant "DocumentNode MS (meEcDocument)" as DMS
database "Database" as DB

== Richiesta di creazione ==
C -> BS : POST /v1/counterparts\nBody: CounterpartDTORequest {name, vatNumber, country, registeredOffice, ..}
activate BS

note right of BS
Il JSON CounterpartDTORequest viene wrappato per la creazione multipla
-> WrapperCounterpartCreateDTORequest
end note

BS -> BS : Inoltra la richiesta a CREATE_COUNTERPART_MULTI 
note right of BS
  HTTP_METHOD = POST
  CONTENT_TYPE = application/json
end note 
BS -> MS : POST {meRepurposingRegEndPoint}/v1/counterparts/multi\nBody: WrapperCounterpartCreateDTORequest{ items[] }
activate MS

MS -> DB : Inserisce nuovi record Counterpart
DB --> MS : Esito creazione OK / errore
MS --> BS : - JSON Response 201 CREATED: CreateMultiDTOResponse {ids[]} \n- Error Response 400 / 409 / 500
deactivate MS

== Inizio flusso asincrono ==
note right of BS
Il servizio avvia in parallelo il flusso per creare i "document node" e aggiornare i Counterpart con il nodeId.
end note

BS -> BS : Avvia CREATE_NODE_FOR_COUNTERPART_LIST
activate BS

BS -> BS : JSON â†’ CreateMultiDTOResponse\nRecupera lista ID counterpart 

== Ricerca dei counterpart creati ==
BS -> BS : Invoca il processo di ricerca dei Counterpart creati per leggerne i dati SEARCH_COUNTERPART_FOR_CREATE_NODE
loop Per ogni pagina di risultati
    BS -> BS : Invoca route interna SEARCH_COUNTERPART
    note right of BS
      HTTP_METHOD = POST
      CONTENT_TYPE = application/json
    end note
    BS -> MS : POST {meRepurposingRegEndPoint}/v1/counterparts/search\nBody: CounterpartSearchDTORequest { ids[], page, pageSize, name, vatNumber, countries[], ..}
    activate MS
    MS -> DB : Query Counterpart per ID con paginazione
    DB --> MS : Esito ricerca
    MS --> BS : - JSON Response 200 OK: WrapperCounterpartDTOResponse { items[], stats } \n- Error Response 404 / 500
    deactivate MS
end loop

== Creazione dei document node ==
loop Per ogni Counterpart trovato
    note right of BS
      HTTP_METHOD = POST
      CONTENT_TYPE = application/json
    end note
    BS -> DMS : POST /v1/documents/nodes\nBody: CreateNodeDTORequest { parentId, name, nodeType, ..}
    activate DMS
    DMS --> BS : - 201 CREATED
    deactivate DMS
    BS -> BS : Recupera il nodeId e aggiorna lista Counterpart con nodeId che viene wrappata in WrapperCounterpartUpdateDTORequest{ items[] }
end loop

== Aggiornamento finale dei Counterpart ==
note right of BS
  HTTP_METHOD = PATCH
  CONTENT_TYPE = application/json
end note
BS -> MS : PATCH {meRepurposingRegEndPoint}/v1/counterparts/multi\nBody: WrapperCounterpartUpdateDTORequest{ items[] }
activate MS
MS -> DB : Aggiorna record Counterpart con nodeId
DB --> MS : Esito aggiornamento
MS --> BS : - 204 NO CONTENT \n- Error Response 400 / 404 / 500
deactivate MS

BS --> C : - 201 CREATED (JSON Response: CreateMultiDTOResponse {ids[]}) \n- 400 / 409 / 500 Error Response
deactivate BS

@enduml
