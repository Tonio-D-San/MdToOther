@startuml
title Counterpart API Routes

left to right direction

skinparam rectangle {
    BackgroundColor #E8F8F5
    BorderColor #1ABC9C
    Shadowing false
}

' ==== API Endpoints ====
rectangle "/v1/counterparts" as CounterpartAPI {
  [GET /{id}] --> [CounterpartService.SEARCH_COUNTERPART_BY_ID]
  [GET /{id}] --> CounterpartDetailDTOResponse : 200
  [GET /{id}] --> ErrorMessageDTO : 404/400/500

  [PATCH /{id}] --> [CounterpartService.UPDATE_COUNTERPART_BY_ID]
  [PATCH /{id}] --> void : 204
  [PATCH /{id}] --> ErrorMessageDTO : 404/400/500

  [POST] --> [CounterpartService.CREATE_COUNTERPART]
  [POST] --> CreateMultiDTOResponse : 201
  [POST] --> ErrorMessageDTO : 400/409/500

  [DELETE /{id}] --> [CounterpartService.DELETE_COUNTERPART_BY_ID]
  [DELETE /{id}] --> void : 204
  [DELETE /{id}] --> ErrorMessageDTO : 400/404/409/500

  [POST /search] --> [CounterpartService.SEARCH_COUNTERPART]
  [POST /search] --> WrapperCounterpartDTOResponse : 200
  [POST /search] --> ErrorMessageDTO : 500

  [POST /import] --> [CounterpartService.CREATE_COUNTERPART_EXCEL]
  [POST /import] --> CreateMultiDTOResponse : 201
  [POST /import] --> ErrorMessageDTO : 400/409/500
}

' ==== Service Layer ====
rectangle "CounterpartService" as Service {
    [SEARCH_COUNTERPART]
    [SEARCH_COUNTERPART_BY_ID]
    [DELETE_COUNTERPART_BY_ID]
    [UPDATE_COUNTERPART_BY_ID]
    [UPDATE_COUNTERPART_MULTI]
    [CREATE_COUNTERPART]
    [CREATE_COUNTERPART_MULTI]
    [CREATE_COUNTERPART_EXCEL]
    [CREATE_NODE_FOR_COUNTERPART_LIST]
    [SEARCH_COUNTERPART_FOR_CREATE_NODE]
}

[CounterpartAPI] --> [Service]

' ==== Service Route Flows ====
[SEARCH_COUNTERPART] --> [External] : POST /v1/counterparts/search
[SEARCH_COUNTERPART_BY_ID] --> [External] : GET /v1/counterparts/{id}
[DELETE_COUNTERPART_BY_ID] --> [External] : DELETE /v1/counterparts/{id}

[UPDATE_COUNTERPART_BY_ID] --> [UPDATE_COUNTERPART_MULTI]
[UPDATE_COUNTERPART_MULTI] --> [External] : PATCH /v1/counterparts/multi

[CREATE_COUNTERPART] --> [CREATE_COUNTERPART_MULTI]
[CREATE_COUNTERPART_MULTI] --> [External] : POST /v1/counterparts/multi
[CREATE_COUNTERPART] --> [CREATE_NODE_FOR_COUNTERPART_LIST] : async wireTap

[CREATE_COUNTERPART_EXCEL] --> [CREATE_COUNTERPART_MULTI]
[CREATE_COUNTERPART_EXCEL] --> [CREATE_NODE_FOR_COUNTERPART_LIST] : async wireTap

[CREATE_NODE_FOR_COUNTERPART_LIST] --> [SEARCH_COUNTERPART_FOR_CREATE_NODE]
[SEARCH_COUNTERPART_FOR_CREATE_NODE] --> [SEARCH_COUNTERPART]
[CREATE_NODE_FOR_COUNTERPART_LIST] --> [NodeService]
[CREATE_NODE_FOR_COUNTERPART_LIST] --> [UPDATE_COUNTERPART_MULTI] : update nodeId

' ==== External Interactions ====
rectangle "External MS Endpoint" as External {
    [POST /v1/counterparts/search]
    [GET /v1/counterparts/{id}]
    [PATCH /v1/counterparts/multi]
    [POST /v1/counterparts/multi]
    [DELETE /v1/counterparts/{id}]
}

[Service] -left-> [External]

rectangle "Document Node Service" as NodeService {
    [OBTAIN_NODE]
}

[CREATE_NODE_FOR_COUNTERPART_LIST] --> NodeService : create node for each counterpart

' ==== Notes ====
note as NoteAPI
  - Ogni endpoint REST chiama una route di servizio corrispondente
  - Le route interne orchestrano creazione, ricerca, aggiornamento e cancellazione
  - Le operazioni CREATE e IMPORT avviano anche un flusso secondario per creare nodi documentali
  - Le risposte di errore seguono lo schema ErrorMessageDTO
end note

CounterpartAPI -down-> NoteAPI


@enduml